---
description: General project conventions for btl.run PWA game
globs: ["**/*"]
alwaysApply: true
---

# btl.run Project Rules

## Project Overview

btl.run is a hyper-efficient PWA game built with:
- **Frontend**: Preact + Vite PWA (in `frontend/`)
- **Game API**: Rust Lambda functions (in `backend/`)
- **AI Service**: Node.js Lambda + OpenAI (in `AskAi_KVS/services/askai/`)
- **KVS Service**: Node.js Lambda + DynamoDB (in `AskAi_KVS/services/kvs/`)
- **Infrastructure**: AWS SAM with nested CloudFormation stacks (in `infrastructure/`)

## Directory Structure

```
btlrunRepo/
├── frontend/          # Preact PWA - static files deployed to S3
├── backend/           # Rust Lambda workspace
│   ├── functions/     # Individual Lambda function crates
│   └── shared/        # Shared library crate
├── infrastructure/    # SAM templates
│   ├── template.yaml  # Root template
│   └── stacks/        # Nested stack templates
└── scripts/           # PowerShell deployment scripts
```

## Code Conventions

### General
- Use TypeScript for frontend, Rust for backend
- Prefer small, focused functions
- Write self-documenting code with minimal comments
- All public APIs must have documentation

### Frontend (Preact)
- Use functional components with hooks
- Keep components small and composable
- Use CSS modules or inline styles for scoping
- Optimize for bundle size - avoid large dependencies
- Call services via environment variables (VITE_*_ENDPOINT)

### Backend (Rust)
- Use `cargo-lambda` for building and testing
- Shared code goes in `backend/shared/`
- Each Lambda function is a separate crate in `backend/functions/`
- Use `lambda_http` for API Gateway integration

### Services (TypeScript/Node.js)
- AskAI and KVS services in `AskAi_KVS/services/`
- Use esbuild for fast bundling
- Shared utilities in `AskAi_KVS/shared/`
- Never hardcode API keys - use Secrets Manager

### Infrastructure
- Use SAM nested stacks for modularity
- Parameters in `infrastructure/parameters/`
- Never hardcode secrets - use SSM Parameter Store or Secrets Manager

## Deployment Commands

```powershell
# Build components
.\scripts\build-frontend.ps1
.\scripts\build-services.ps1
.\scripts\build-backend.ps1

# Deploy everything
.\scripts\deploy.ps1 -Environment dev

# Deploy individual stacks
.\scripts\deploy-stack.ps1 -Stack services -Environment dev  # AskAI + KVS
.\scripts\deploy-stack.ps1 -Stack api -Environment dev       # Rust game API
.\scripts\deploy-stack.ps1 -Stack storage -Environment dev   # S3 + DynamoDB
.\scripts\deploy-stack.ps1 -Stack cdn -Environment dev       # CloudFront
```

## File Naming

- Frontend components: PascalCase (e.g., `GameBoard.tsx`)
- Frontend utilities: camelCase (e.g., `gameUtils.ts`)
- Rust files: snake_case (e.g., `game_logic.rs`)
- Infrastructure: kebab-case (e.g., `api-gateway.yaml`)
