---
alwaysApply: true
---

# Cursor Rule: Architecture

Frontend:
- frontend/ (Preact + Vite + TypeScript PWA)
- Highly optimized bundle with service worker for offline support
- Modern UI based on mockups in uiux_mockups/

Backend:
- backend/ (Rust Lambda game API)
- AskAi_KVS/services/ (TypeScript Lambda services)
  - askai/ (OpenAI wrapper)
  - kvs/ (DynamoDB key-value storage)
- AskAi_KVS/shared/ (shared schemas, clients, utilities)

Infrastructure:
- infrastructure/ (AWS SAM with nested CloudFormation stacks)
- Deploys: S3, CloudFront, Lambda (Rust + Node.js), HTTP API Gateway, DynamoDB, Secrets Manager

Commands (PowerShell):
- `cd frontend && pnpm dev` — Vite dev server (localhost:5173)
- `PORT=9002 npx tsx AskAi_KVS/mocks/kvs-server.ts` — Mock KVS (localhost:9002)
- `npx tsx AskAi_KVS/mocks/askai-server.ts` — Mock AskAI (localhost:9001)
- `cd backend && cargo lambda watch` — Local Rust Lambda
- `.\scripts\deploy.ps1 -Environment dev` — Deploy full stack
- `.\scripts\deploy-stack.ps1 -Stack services` — Deploy services only
- `sam validate --template infrastructure/template.yaml` — Validate templates

Persistence:
- KVS service backed by DynamoDB
- Table: btl-run-kvs-{env} (pk, sk, value, updatedAt)
- Suggested key patterns:
  - game:{id}:events (append-only event log)
  - game:{id}:snapshot (materialized state)
  - game:{id}:meta (game metadata)
  - player:{id}:profile

Game:
- Lobby → Active → Completed
- Quick Play: turn-based advance
- Long Play: daily submissions + daily resolution
- Anti-infinite: max days + hazard escalation + forced convergence